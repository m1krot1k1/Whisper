# Оптимизированная конфигурация WhisperLiveKit для телефонных звонков

## Анализ проблемы

Пользователь сталкивается с проблемой неправильного распознавания слов при транскрипции телефонных звонков с плохим качеством связи. Это типичная проблема, которая решается комбинацией правильной настройки промптов и оптимизации параметров.

## Ключевые параметры для улучшения качества транскрипции

### 1. Системные промпты (INIT_PROMPT и STATIC_INIT_PROMPT)

**Текущие промпты:**
- `WLK_INIT_PROMPT="Привет! Говорите четко и медленно. О чём хотите поговорить?"`
- `WLK_STATIC_INIT_PROMPT="Русская речь. Четкое произношение. Литературный язык. Полные предложения. Правильная пунктуация. Разборчивая речь."`

**Оптимизированные промпты для телефонных звонков:**

```env
# Инициализационный промпт для телефонных разговоров
WLK_INIT_PROMPT="Телефонный разговор. Четкая русская речь. Полные предложения с правильной пунктуацией. Говорящий произносит слова разборчиво и внятно."

# Статичный промпт с терминологией для деловых звонков
WLK_STATIC_INIT_PROMPT="Русская деловая речь. Телефонный разговор между коллегами. Четкое произношение. Правильная грамматика. Полные предложения. Избегать сокращений. Использовать литературный язык. Качественная транскрипция разговора."
```

### 2. Критические параметры модели

```env
# Модель - small оптимальна для русского языка и скорости
WLK_MODEL=small

# Язык - всегда указывать конкретно для лучшего качества
WLK_LANGUAGE=ru

# Бэкенд - faster-whisper более стабилен для плохого аудио
WLK_BACKEND=faster-whisper

# Отключить быстрый энкодер для лучшего качества на плохом аудио
WLK_DISABLE_FAST_ENCODER=true
```

### 3. Оптимизация для SimulStreaming

```env
# Увеличить порог для лучшей точности (компромисс скорость/качество)
WLK_FRAME_THRESHOLD=30

# Использовать beam search для лучшего качества
WLK_BEAMS=3

# Принудительно использовать beam декодер
WLK_DECODER_TYPE=beam

# Увеличить максимальную длину буфера для контекста
WLK_AUDIO_MAX_LEN=20

# Минимальная длина для избежания обработки коротких шумов
WLK_AUDIO_MIN_LEN=0.5
```

### 4. Настройки VAD и аудиобуфера

```env
# Уменьшить размер чанка для быстрого отклика, но не слишком мало
WLK_MIN_CHUNK_SIZE=0.8

# Обязательно оставить VAD включенным для фильтрации шумов
WLK_NO_VAD=false
WLK_NO_VAC=false

# Увеличить размер чанка VAC для стабильности
WLK_VAC_CHUNK_SIZE=0.06

# Настройка обрезки буфера по сегментам
WLK_BUFFER_TRIMMING=segment
WLK_BUFFER_TRIMMING_SEC=20
```

### 5. Дополнительные оптимизации

```env
# Никогда не обрезать неполные слова при плохом аудио
WLK_NEVER_FIRE=true

# Увеличить количество предзагруженных моделей для стабильности
WLK_PRELOADED_MODEL_COUNT=2

# Отключить валидацию по уверенности для сохранения всех слов
WLK_CONFIDENCE_VALIDATION=false
```

## Полный оптимизированный файл .env

```env
# =================================================================
# ОПТИМИЗИРОВАННАЯ КОНФИГУРАЦИЯ ДЛЯ ТЕЛЕФОННЫХ ЗВОНКОВ
# =================================================================

# Хост и порт
WLK_HOST=localhost
WLK_PORT=8000

# =================================================================
# КОНФИГУРАЦИЯ МОДЕЛИ ДЛЯ ТЕЛЕФОННЫХ ЗВОНКОВ
# =================================================================

# Модель small - оптимальный баланс качества/скорости для русского языка
WLK_MODEL=small

# Всегда указывать русский язык конкретно
WLK_LANGUAGE=ru

# Задача транскрипции
WLK_TASK=transcribe

# faster-whisper более стабилен для плохого качества аудио
WLK_BACKEND=faster-whisper

# Кэш моделей
WLK_MODEL_CACHE_DIR=./models

# =================================================================
# ПРОМПТЫ ДЛЯ ТЕЛЕФОННЫХ ЗВОНКОВ
# =================================================================

# Промпт, настроенный специально для телефонных разговоров
WLK_INIT_PROMPT="Деловой телефонный разговор между коллегами на русском языке. Четкая речь, правильная грамматика, полные предложения с пунктуацией."

# Статичный промпт с деловой терминологией
WLK_STATIC_INIT_PROMPT="Русская деловая речь. Телефонная связь. Профессиональный разговор. Четкое произношение слов. Правильная пунктуация и грамматика. Полные развернутые предложения. Избегать жаргонизмов. Литературный русский язык."

# =================================================================
# ОПТИМИЗАЦИЯ КАЧЕСТВА АУДИООБРАБОТКИ
# =================================================================

# Размер чанка - компромисс между скоростью и контекстом
WLK_MIN_CHUNK_SIZE=0.8

# Обязательно включить VAD для фильтрации шумов телефонной связи
WLK_NO_VAD=false
WLK_NO_VAC=false

# Размер чанка VAC для стабильной работы с шумными каналами
WLK_VAC_CHUNK_SIZE=0.06

# Обрезка буфера по сегментам Whisper
WLK_BUFFER_TRIMMING=segment
WLK_BUFFER_TRIMMING_SEC=20

# =================================================================
# НАСТРОЙКИ SIMULSTREAMING ДЛЯ КАЧЕСТВА
# =================================================================

# Отключить быстрый энкодер для лучшего качества
WLK_DISABLE_FAST_ENCODER=true

# Увеличить порог для лучшей точности (30 вместо 20)
WLK_FRAME_THRESHOLD=30

# Использовать beam search с 3 лучами
WLK_BEAMS=3

# Принудительно использовать beam декодер для качества
WLK_DECODER_TYPE=beam

# Увеличить максимальную длину буфера
WLK_AUDIO_MAX_LEN=20

# Минимальная длина для избежания шумов
WLK_AUDIO_MIN_LEN=0.5

# Никогда не обрезать неполные слова
WLK_NEVER_FIRE=true

# Максимальное количество контекстных токенов
WLK_MAX_CONTEXT_TOKENS=448

# Предзагрузить 2 модели для стабильности
WLK_PRELOADED_MODEL_COUNT=2

# =================================================================
# ДОПОЛНИТЕЛЬНЫЕ НАСТРОЙКИ КАЧЕСТВА
# =================================================================

# Отключить валидацию по уверенности
WLK_CONFIDENCE_VALIDATION=false

# Оставить транскрипцию включенной
WLK_NO_TRANSCRIPTION=false

# Уровень логирования для мониторинга качества
WLK_LOG_LEVEL=INFO

# =================================================================
# ДИАРИЗАЦИЯ (ОТКЛЮЧЕНА ДЛЯ СТАБИЛЬНОСТИ)
# =================================================================

# Отключить диаризацию для концентрации на качестве транскрипции
WLK_DIARIZATION=false

# =================================================================
# GUNICORN ДЛЯ ПРОДАКШЕНА
# =================================================================

# Меньше воркеров для стабильности при плохом аудио
WLK_GUNICORN_WORKERS=4
WLK_GUNICORN_WORKER_CLASS=uvicorn.workers.UvicornWorker
WLK_GUNICORN_TIMEOUT=300
WLK_GUNICORN_MAX_REQUESTS=1000
WLK_GUNICORN_BACKLOG=2048
WLK_GUNICORN_PRELOAD=true

# =================================================================
# ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ ДЛЯ СТАБИЛЬНОСТИ
# =================================================================

# Принудительное использование CPU для стабильности
export CUDA_VISIBLE_DEVICES=""
export WHISPER_DEVICE=cpu
export WHISPER_CUDA=0

# Оптимизация для CPU
export OMP_NUM_THREADS=4
export MKL_NUM_THREADS=4
export OPENBLAS_NUM_THREADS=4

# Отключить предупреждения
export PYTHONWARNINGS="ignore::UserWarning"
export TORCH_WARN_LEVEL="0"
export TORCH_USE_NNPACK=0
export TORCH_SHOW_CPP_STACKTRACES=0
```

## Дополнительные рекомендации

### 1. Предобработка аудио с FFmpeg

Для кардинального улучшения качества рекомендуется предобрабатывать аудио:

```bash
# Базовая обработка для телефонных записей
ffmpeg -i input.wav -af "highpass=f=300,lowpass=f=3400,volume=2.0,arnndn=m=./models/rnn/bd.rnnn" -ar 16000 -ac 1 output.wav

# Продвинутая обработка с нормализацией
sox input.wav -r 16k output.wav norm -0.5 compand 0.3,1 -90,-90,-70,-70,-60,-20,0,0 -5 0 0.2
```

### 2. Параметры для different-whisper

Если использовать напрямую faster-whisper:

```python
from faster_whisper import WhisperModel

model = WhisperModel("small", device="cpu", compute_type="float32")

segments, info = model.transcribe(
    audio_path,
    language="ru",
    beam_size=5,
    temperature=0.0,
    initial_prompt="Деловой телефонный разговор на русском языке с четким произношением.",
    condition_on_previous_text=True,
    no_speech_threshold=0.3,
    logprob_threshold=-0.8,
    compression_ratio_threshold=2.6,
    word_timestamps=True
)
```

### 3. Мониторинг качества

Добавить логирование для отслеживания проблем:

```bash
# Запуск с детальным логированием
WLK_LOG_LEVEL=DEBUG whisperlivekit-server --config .env
```

## Заключение

Данная конфигурация оптимизирована специально для:
- Телефонных звонков с плохим качеством связи
- Русской речи
- Деловых разговоров
- Стабильной работы на CPU

Ключевые улучшения:
1. **Специализированные промпты** для телефонной речи
2. **Более консервативные параметры** для качества вместо скорости
3. **Улучшенная фильтрация** через VAD
4. **Beam search** вместо greedy декодирования
5. **Предобработка аудио** для устранения шумов связи