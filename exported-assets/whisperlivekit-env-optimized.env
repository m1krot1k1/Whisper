# Оптимизированная конфигурация WhisperLiveKit для телефонных звонков
# Специально настроена для русской речи с плохим качеством связи
# Версия: 2.0 - Телефония Pro

# =================================================================
# КОНФИГУРАЦИЯ СЕРВЕРА
# =================================================================

WLK_HOST=localhost
WLK_PORT=8000

# SSL (если нужен HTTPS)
# WLK_SSL_CERTFILE=/path/to/certificate.pem
# WLK_SSL_KEYFILE=/path/to/private_key.pem

# =================================================================
# КОНФИГУРАЦИЯ МОДЕЛИ ДЛЯ ТЕЛЕФОННЫХ ЗВОНКОВ
# =================================================================

# small модель - лучший баланс качества/скорости для русского языка
# medium и large склонны к галлюцинациям при плохом аудио
WLK_MODEL=small

# ОБЯЗАТЕЛЬНО указывать русский язык, НЕ используйте auto
WLK_LANGUAGE=ru

# Только транскрипция, без перевода
WLK_TASK=transcribe

# faster-whisper наиболее стабилен для плохого качества связи
# simulstreaming может пропускать слова при шумах
WLK_BACKEND=faster-whisper

# Директория для кэша моделей
WLK_MODEL_CACHE_DIR=./models

# =================================================================
# СИСТЕМНЫЕ ПРОМПТЫ ДЛЯ ТЕЛЕФОННЫХ ЗВОНКОВ
# =================================================================

# Промпт прокручивается с контекстом разговора
# КРИТИЧНО: Укажите тип разговора и ожидаемую речь
WLK_INIT_PROMPT="Деловой телефонный разговор между коллегами. Четкая русская речь с правильным произношением. Полные предложения с пунктуацией. Профессиональная деловая лексика. Говорящие произносят слова внятно и разборчиво."

# Статичный промпт не прокручивается, задает общий стиль
# Добавьте специфичную терминологию вашей области
WLK_STATIC_INIT_PROMPT="Русская деловая речь. Телефонная связь. Профессиональный разговор между сотрудниками компании. Четкое произношение каждого слова. Правильная грамматика и пунктуация. Полные развернутые предложения. Литературный русский язык без жаргона. Качественная транскрипция телефонного диалога. Избегать сокращений и неологизмов."

# =================================================================
# АУДИООБРАБОТКА ДЛЯ ПЛОХОГО КАЧЕСТВА СВЯЗИ
# =================================================================

# Размер чанка - НЕ делайте слишком маленьким для телефонии
# 0.8 сек обеспечивает контекст для правильного распознавания
WLK_MIN_CHUNK_SIZE=0.8

# ОБЯЗАТЕЛЬНО оставить включенными для фильтрации шумов связи
WLK_NO_VAD=false
WLK_NO_VAC=false

# Размер чанка VAC - увеличен для стабильности на шумных каналах
WLK_VAC_CHUNK_SIZE=0.06

# Прогрев модели стандартным файлом
# WLK_WARMUP_FILE=false  # отключить, если не нужен

# Обрезка буфера по сегментам Whisper (НЕ по предложениям)
WLK_BUFFER_TRIMMING=segment
WLK_BUFFER_TRIMMING_SEC=20

# =================================================================
# ДИАРИЗАЦИЯ (РЕКОМЕНДУЕТСЯ ОТКЛЮЧИТЬ)
# =================================================================

# Отключена для концентрации на качестве транскрипции
# Включите только если критично важно различать говорящих
WLK_DIARIZATION=false

# Если все же нужна диаризация:
# WLK_DIARIZATION=true
# WLK_DIARIZATION_BACKEND=diart
# WLK_SEGMENTATION_MODEL=pyannote/segmentation-3.0
# WLK_EMBEDDING_MODEL=speechbrain/spkrec-ecapa-voxceleb
# HUGGINGFACE_HUB_TOKEN=ваш_токен_здесь

# =================================================================
# НАСТРОЙКИ SIMULSTREAMING (если используется)
# =================================================================

# Отключить для стабильной работы с CPU
WLK_DISABLE_FAST_ENCODER=true

# Порог AlignAtt - КЛЮЧЕВОЙ параметр качества
# 30 = высокое качество, медленнее
# 25 = баланс качества/скорости  
# 20 = быстро, но может пропускать слова
WLK_FRAME_THRESHOLD=30

# Beam search для лучшего качества вместо greedy
# 3-5 лучей оптимально для телефонии
WLK_BEAMS=3

# Принудительно использовать beam search
WLK_DECODER_TYPE=beam

# Максимальная длина буфера - увеличена для контекста
WLK_AUDIO_MAX_LEN=20

# Минимальная длина - защита от коротких шумов связи
WLK_AUDIO_MIN_LEN=0.5

# КРИТИЧНО: Никогда не обрезать слова при плохом аудио
WLK_NEVER_FIRE=true

# Максимальное количество токенов контекста
WLK_MAX_CONTEXT_TOKENS=448

# Предзагрузка моделей для стабильности
WLK_PRELOADED_MODEL_COUNT=2

# =================================================================
# ДОПОЛНИТЕЛЬНЫЕ НАСТРОЙКИ КАЧЕСТВА
# =================================================================

# Отключить быструю валидацию - сохраняет больше слов
WLK_CONFIDENCE_VALIDATION=false

# Пунктуация включена
# WLK_PUNCTUATION_SPLIT=true

# Транскрипция включена (очевидно)
WLK_NO_TRANSCRIPTION=false

# Уровень логирования для отладки проблем качества
WLK_LOG_LEVEL=INFO

# =================================================================
# GUNICORN ДЛЯ ПРОДАКШЕН-РАЗВЕРТЫВАНИЯ
# =================================================================

# Меньше воркеров для стабильности обработки плохого аудио
WLK_GUNICORN_WORKERS=4
WLK_GUNICORN_WORKER_CLASS=uvicorn.workers.UvicornWorker

# Увеличенный таймаут для обработки сложных аудиофайлов
WLK_GUNICORN_TIMEOUT=300
WLK_GUNICORN_MAX_REQUESTS=1000
WLK_GUNICORN_BACKLOG=2048
WLK_GUNICORN_PRELOAD=true

# Graceful restart
WLK_GUNICORN_GRACEFUL_TIMEOUT=30
WLK_GUNICORN_PIDFILE=./gunicorn.pid

# Логи Gunicorn
WLK_GUNICORN_ACCESS_LOG=./logs/gunicorn_access.log
WLK_GUNICORN_ERROR_LOG=./logs/gunicorn_error.log

# =================================================================
# СИСТЕМНЫЕ ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ
# =================================================================

# Принудительное использование CPU для стабильности
# GPU может давать сбои при обработке шумного аудио
export CUDA_VISIBLE_DEVICES=""
export WHISPER_DEVICE=cpu
export WHISPER_CUDA=0

# Оптимизация потоков CPU для аудиообработки
export OMP_NUM_THREADS=4
export MKL_NUM_THREADS=4
export OPENBLAS_NUM_THREADS=4

# Подавление предупреждений для чистого вывода
export PYTHONWARNINGS="ignore::UserWarning"
export TORCH_WARN_LEVEL="0"
export TORCH_USE_NNPACK=0
export TORCH_USE_QNNPACK=0
export TORCH_SHOW_CPP_STACKTRACES=0
export TORCH_USE_CUDA_DSA=0

# =================================================================
# ПРИМЕРЫ СПЕЦИАЛИЗИРОВАННЫХ ПРОМПТОВ ДЛЯ РАЗНЫХ ОБЛАСТЕЙ
# =================================================================

# Для медицинских консультаций:
# WLK_STATIC_INIT_PROMPT="Медицинская консультация по телефону. Врач и пациент говорят на русском языке. Медицинская терминология: диагноз, симптомы, лечение, препараты, анализы. Четкое произношение медицинских терминов."

# Для юридических консультаций:
# WLK_STATIC_INIT_PROMPT="Юридическая консультация по телефону. Юрист и клиент обсуждают правовые вопросы на русском языке. Юридическая терминология: законодательство, правонарушение, иск, договор, права."

# Для технической поддержки:
# WLK_STATIC_INIT_PROMPT="Техническая поддержка по телефону. Специалист помогает пользователю решить техническую проблему. IT-терминология: программное обеспечение, настройки, система, ошибка, обновление."

# Для продаж:
# WLK_STATIC_INIT_PROMPT="Телефонные продажи на русском языке. Менеджер предлагает товары и услуги клиенту. Деловая лексика: предложение, цена, скидка, заказ, доставка, оплата."

# =================================================================
# ИНСТРУКЦИИ ПО ИСПОЛЬЗОВАНИЮ
# =================================================================

# 1. Скопируйте этот файл как .env в корневую папку WhisperLiveKit
# 2. Создайте папки ./models и ./logs если их нет
# 3. Настройте FFmpeg для предобработки аудио (см. документацию)
# 4. Запустите: whisperlivekit-server --config .env
# 5. Мониторьте качество через логи и корректируйте промпты

# =================================================================
# ДОПОЛНИТЕЛЬНЫЕ РЕКОМЕНДАЦИИ
# =================================================================

# Предобработка аудио FFmpeg (выполните ДО транскрипции):
# ffmpeg -i input.wav -af "highpass=f=300,lowpass=f=3400,volume=1.5" -ar 16000 -ac 1 output.wav

# Нормализация громкости SOX:
# sox input.wav -r 16k output.wav norm -0.5 compand 0.3,1 -90,-90,-70,-70,-60,-20,0,0 -5 0 0.2

# Шумоподавление RNNoise:
# ffmpeg -i input.wav -af "arnndn=m=./models/rnn/bd.rnnn" output.wav